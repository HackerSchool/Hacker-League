<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hacker League - History</title>
        <link rel="stylesheet" href="/css/styles.css">
        <link rel="stylesheet" href="/css/navbar.css">
        <link rel="stylesheet" href="/css/history.css">
        <script type="module" src="js/app.js" defer></script>
    </head>
    <body>
        <nav class="navbar">
            <div class="navbar-brand">
                <img class="logo" src="/static/images/HS_NOVO.svg" alt="HS Dashboard">
            </div>
            <div class="navbar-links">
                <a href="/profile">Profile</a>
                <a href="/leaderboard">Leaderboard</a>
                <a href="/members">Members</a>
                <a href="/logout">Logout</a>
            </div>
            <div class="hamburger-menu">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="hamburger-content">
                    <a href="/profile">Profile</a>
                    <a href="/leaderboard">Leaderboard</a>
                    <a href="/members">Members</a>
                    <a href="/logout">Logout</a>
                </div>
            </div>
        </nav>

        <div class="history-container">
            <header class="history-header">
                <h1>üìä Points History</h1>
                <p>Track all point activities and achievements</p>
            </header>



            <div class="history-content">
                <div id="historyTable" class="history-table">
                    <!-- History table will be populated here -->
                </div>
            </div>

            <div class="pagination-controls">
                <button id="prevPage" class="pagination-btn" disabled>
                    <span>‚Üê</span> Previous
                </button>
                <div class="page-info">
                    <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </div>
                <button id="nextPage" class="pagination-btn">
                    Next <span>‚Üí</span>
                </button>
            </div>
        </div>

        <script type="module">
            // Import the history service
            import { getTeams, getIndividuals, getAllHistoryData } from '/js/services/leaderboardService.js';

            // Global variables for pagination
            let currentPage = 1;
            let itemsPerPage = 10;
            let currentEntityType = 'teams';
            let currentEntityFilter = 'all';
            let currentPointsType = 'all';
            let allHistoryData = [];

            // Initialize history page
            document.addEventListener('DOMContentLoaded', function() {
                initializeHistory();
                setupEventListeners();
                setupHamburgerMenu();
            });

            function initializeHistory() {
                loadHistoryData(); // Load data first
                loadEntityOptions(); // Then load filter options
            }

            function setupEventListeners() {
                // Pagination buttons
                document.getElementById('prevPage').addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        renderHistoryTable();
                    }
                });

                document.getElementById('nextPage').addEventListener('click', function() {
                    const totalPages = Math.ceil(getFilteredData().length / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderHistoryTable();
                    }
                });
            }

            async function loadEntityOptions() {
                const entityFilterSelect = document.getElementById('entityFilter');
                const entityTypeSelect = document.getElementById('entityType');
                
                if (!entityFilterSelect || !entityTypeSelect) return;
                
                // Clear existing options and add "All" as default
                entityFilterSelect.innerHTML = '<option value="all" selected>All</option>';
                
                try {
                    if (entityTypeSelect.value === 'teams') {
                        // Load teams for filtering
                        const teams = await getTeams();
                        teams.forEach(team => {
                            const option = document.createElement('option');
                            option.value = team.name;
                            option.textContent = team.name;
                            entityFilterSelect.appendChild(option);
                        });
                    } else {
                        // Load members for filtering
                        const members = await getIndividuals();
                        members.forEach(member => {
                            const option = document.createElement('option');
                            option.value = member.name;
                            option.textContent = member.name;
                            entityFilterSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading entity options:', error);
                }
            }

            async function loadHistoryData() {
                try {
                    // Load all history data from the service
                    allHistoryData = await getAllHistoryData();
                    renderHistoryTable();
                } catch (error) {
                    console.error('Error loading history data:', error);
                }
            }



            function getFilteredData() {
                let filtered = allHistoryData;
                
                // Filter by entity
                if (currentEntityFilter !== 'all') {
                    if (currentEntityType === 'teams') {
                        filtered = filtered.filter(entry => entry.equipa === currentEntityFilter);
                    } else {
                        filtered = filtered.filter(entry => entry.membro === currentEntityFilter);
                    }
                }
                
                // Filter by points type
                if (currentPointsType !== 'all') {
                    filtered = filtered.filter(entry => entry.tipo === currentPointsType);
                }
                
                return filtered;
            }

            function renderHistoryTable() {
                const tableContainer = document.getElementById('historyTable');
                const filteredData = getFilteredData();
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                
                // Calculate pagination
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageData = filteredData.slice(startIndex, endIndex);
                
                let tableHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>
                                    <div class="header-controls">
                                        <span>${currentEntityType === 'teams' ? 'Team' : 'Member'}</span>
                                        <select id="entityType" class="inline-select">
                                            <option value="teams" ${currentEntityType === 'teams' ? 'selected' : ''}>Teams</option>
                                            <option value="members" ${currentEntityType === 'members' ? 'selected' : ''}>Members</option>
                                        </select>
                                    </div>
                                </th>
                                ${currentEntityType === 'members' ? '<th>Team</th>' : ''}
                                <th>
                                    <div class="header-controls">
                                        <span>Type</span>
                                        <select id="pointsType" class="inline-select">
                                            <option value="all" ${currentPointsType === 'all' ? 'selected' : ''}>All</option>
                                            <option value="PJ" ${currentPointsType === 'PJ' ? 'selected' : ''}>PJ</option>
                                            <option value="PCC" ${currentPointsType === 'PCC' ? 'selected' : ''}>PCC</option>
                                        </select>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-controls">
                                        <span>Points</span>
                                        <select id="entityFilter" class="inline-select">
                                            <option value="all">All</option>
                                        </select>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (pageData.length === 0) {
                    tableHTML += `
                        <tr>
                            <td colspan="${currentEntityType === 'members' ? '5' : '4'}" class="no-data">
                                No history entries found for the selected filters.
                            </td>
                        </tr>
                    `;
                } else {
                    pageData.forEach((entry, index) => {
                        const rowId = `history-row-${currentPage}-${index}`;
                        tableHTML += `
                            <tr class="history-row clickable-row" data-description="${entry.descri√ß√£o}" data-row-id="${rowId}">
                                <td class="date-cell">${formatDate(entry.data)}</td>
                                <td class="entity-cell">${currentEntityType === 'teams' ? entry.equipa : entry.membro}</td>
                                ${currentEntityType === 'members' ? `<td class="team-cell">${entry.equipa}</td>` : ''}
                                <td class="type-cell">
                                    <span class="points-type ${entry.tipo.toLowerCase()}">${entry.tipo}</span>
                                </td>
                                <td class="points-cell">+${entry.pontos}</td>
                            </tr>
                            <tr class="description-row" id="${rowId}" style="display: none;">
                                <td colspan="${currentEntityType === 'members' ? '5' : '4'}" class="description-cell">
                                    <div class="description-content">
                                        <h4>üìù Activity Description</h4>
                                        <p>${entry.descri√ß√£o}</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }

                tableHTML += `
                        </tbody>
                    </table>
                `;

                tableContainer.innerHTML = tableHTML;
                
                // Add click event listeners for history rows
                setupHistoryRowClicks();
                
                // Set up event listeners for the inline dropdowns
                setupInlineDropdowns();
                
                // Load filter options after table is rendered
                loadEntityOptions();
                
                // Update pagination controls
                updatePaginationControls(totalPages);
            }

            function updatePaginationControls(totalPages) {
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');
                const currentPageSpan = document.getElementById('currentPage');
                const totalPagesSpan = document.getElementById('totalPages');
                
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages;
                
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric',
                    month: 'short', 
                    day: 'numeric'
                });
            }

            function setupHistoryRowClicks() {
                const historyRows = document.querySelectorAll('.history-row.clickable-row');
                historyRows.forEach(row => {
                    row.addEventListener('click', function() {
                        const rowId = this.getAttribute('data-row-id');
                        const descriptionRow = document.getElementById(rowId);
                        if (descriptionRow) {
                            descriptionRow.style.display = descriptionRow.style.display === 'none' ? 'table-row' : 'none';
                        }
                    });
                });
            }

            function setupInlineDropdowns() {
                // Entity type dropdown
                const entityTypeSelect = document.getElementById('entityType');
                if (entityTypeSelect) {
                    entityTypeSelect.addEventListener('change', function() {
                        currentEntityType = this.value;
                        currentEntityFilter = 'all'; // Reset filter to "All"
                        currentPage = 1;
                        loadEntityOptions(); // This will reload the filter options
                        loadHistoryData();
                    });
                }

                // Points type dropdown
                const pointsTypeSelect = document.getElementById('pointsType');
                if (pointsTypeSelect) {
                    pointsTypeSelect.addEventListener('change', function() {
                        currentPointsType = this.value;
                        currentPage = 1;
                        renderHistoryTable();
                    });
                }

                // Entity filter dropdown (next to "Points" title)
                const entityFilterSelect = document.getElementById('entityFilter');
                if (entityFilterSelect) {
                    entityFilterSelect.addEventListener('change', function() {
                        currentEntityFilter = this.value;
                        currentPage = 1;
                        renderHistoryTable();
                    });
                }
            }

            function setupHamburgerMenu() {
                const hamburgerMenu = document.querySelector('.hamburger-menu');
                if (hamburgerMenu) {
                    hamburgerMenu.addEventListener('click', function() {
                        this.classList.toggle('active');
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', function(event) {
                        if (!hamburgerMenu.contains(event.target)) {
                            hamburgerMenu.classList.remove('active');
                        }
                    });
                }
            }


        </script>
    </body>
</html> 