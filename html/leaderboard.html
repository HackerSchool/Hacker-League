<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Hacker League - Leaderboard</title>
        <link rel="stylesheet" href="/css/styles.css">
        <link rel="stylesheet" href="/css/navbar.css">
        <link rel="stylesheet" href="/css/leaderboard.css">
        <script type="module" src="js/app.js" defer></script>
    </head>
    <body>
        <nav class="navbar">
            <div class="navbar-brand">
                <img class="logo" src="/static/images/HS_NOVO.svg" alt="HS Dashboard">
            </div>
            <div class="navbar-links">
                <a href="/profile">Profile</a>
                <a href="/history">History</a>
                <a href="/members">Members</a>
                <a href="/logout">Logout</a>
            </div>
            <div class="hamburger-menu">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="hamburger-content">
                    <a href="/profile">Profile</a>
                    <a href="/leaderboard">Leaderboard</a>
                    <a href="/history">History</a>
                    <a href="/members">Members</a>
                    <a href="/logout">Logout</a>
                </div>
            </div>
        </nav>

        <div class="leaderboard-container">
            <header class="leaderboard-header">
                <h1>üèÜ Hacker League Leaderboard</h1>
                <p>Track your progress and compete with the best hackers!</p>
            </header>

            <div class="leaderboard-content">
                <div id="leaderboardTable" class="leaderboard-table">
                    <!-- Leaderboard will be populated here -->
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-card">
                    <h3>Total Participants</h3>
                    <span id="totalParticipants">0</span>
                </div>
                <div class="stat-card">
                    <h3>Active Teams</h3>
                    <span id="activeTeams">0</span>
                </div>
                <div class="stat-card">
                    <h3>Total Points</h3>
                    <span id="totalPoints">0</span>
                </div>
            </div>
        </div>

        <script type="module">
            // Import the leaderboard service
            import { getTeams, getIndividuals, getLeaderboardStats, getTeamHistory } from '/js/services/leaderboardService.js';

            // Initialize leaderboard
            document.addEventListener('DOMContentLoaded', function() {
                initializeLeaderboard();
                setupEventListeners();
                updateStats();
                setupHamburgerMenu();
            });

            function initializeLeaderboard() {
                renderLeaderboard('team', 'total');
            }

            function setupEventListeners() {
                // Event listeners will be set up in renderLeaderboard
            }

            async function renderLeaderboard(classificationType, pointsType) {
                const tableContainer = document.getElementById('leaderboardTable');
                const data = classificationType === 'team' ? await getTeams() : await getIndividuals();
                
                // Sort data based on points type
                const sortedData = [...data].sort((a, b) => {
                    const aPoints = pointsType === 'total' ? a.totalPoints : 
                                   pointsType === 'pj' ? a.pjPoints : a.pccPoints;
                    const bPoints = pointsType === 'total' ? b.totalPoints : 
                                   pointsType === 'pj' ? b.pjPoints : b.pccPoints;
                    return bPoints - aPoints;
                });

                let tableHTML = `
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>
                                    <div class="header-controls">
                                        <span>Rank</span>
                                        <select id="pointsType" class="inline-select">
                                            <option value="total" ${pointsType === 'total' ? 'selected' : ''}>Total</option>
                                            <option value="pj" ${pointsType === 'pj' ? 'selected' : ''}>PJ</option>
                                            <option value="pcc" ${pointsType === 'pcc' ? 'selected' : ''}>PCC</option>
                                        </select>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-controls">
                                        <span>${classificationType === 'team' ? 'Team' : 'Name'}</span>
                                        <select id="classificationType" class="inline-select">
                                            <option value="team" ${classificationType === 'team' ? 'selected' : ''}>Teams</option>
                                            <option value="individual" ${classificationType === 'individual' ? 'selected' : ''}>Individuals</option>
                                        </select>
                                    </div>
                                </th>
                                ${classificationType === 'individual' ? '<th>Team</th>' : '<th>Members</th>'}
                                <th>Total Points</th>
                                <th>PJ Points</th>
                                <th>PCC Points</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                sortedData.forEach((item, index) => {
                    const rank = index + 1;
                    
                    const rankClass = rank <= 5 ? `rank-${rank}` : '';

                    tableHTML += `
                        <tr class="${rankClass} clickable-row" data-team="${item.name}">
                            <td class="rank-cell">
                                <span class="rank-number">${rank}</span>
                            </td>
                            <td class="name-cell">${item.name}</td>
                            ${classificationType === 'individual' ? 
                                `<td class="team-cell">${item.team}</td>` : 
                                `<td class="members-cell">${item.members} members</td>`
                            }
                            <td class="points-cell">${item.totalPoints}</td>
                            <td class="pj-points">${item.pjPoints}</td>
                            <td class="pcc-points">${item.pccPoints}</td>
                        </tr>
                        <tr class="history-row" id="history-${item.name.replace(/\s+/g, '-')}" style="display: none;">
                            <td colspan="6" class="history-cell">
                                <div class="history-content">
                                    <h4>üìä Recent Activity</h4>
                                    <div class="history-list" id="history-list-${item.name.replace(/\s+/g, '-')}">
                                        <div class="loading">Loading history...</div>
                                    </div>
                                    <div class="history-footer">
                                        <button class="see-more-btn" onclick="window.location.href='/history'">
                                            See more...
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += `
                        </tbody>
                    </table>
                `;

                tableContainer.innerHTML = tableHTML;
                
                // Set up event listeners for the inline dropdowns
                setupInlineDropdowns();
                
                // Add click event listeners for history dropdown
                setupHistoryDropdowns();
            }

            function setupInlineDropdowns() {
                // Classification type dropdown
                const classificationSelect = document.getElementById('classificationType');
                if (classificationSelect) {
                    classificationSelect.addEventListener('change', function() {
                        const classificationType = this.value;
                        const pointsType = document.getElementById('pointsType').value;
                        renderLeaderboard(classificationType, pointsType);
                    });
                }

                // Points type dropdown
                const pointsSelect = document.getElementById('pointsType');
                if (pointsSelect) {
                    pointsSelect.addEventListener('change', function() {
                        const classificationType = document.getElementById('classificationType').value;
                        const pointsType = this.value;
                        renderLeaderboard(classificationType, pointsType);
                    });
                }
            }

            function setupHistoryDropdowns() {
                const clickableRows = document.querySelectorAll('.clickable-row');
                
                clickableRows.forEach(row => {
                    row.addEventListener('click', async function() {
                        const teamName = this.getAttribute('data-team');
                        const historyRow = document.getElementById(`history-${teamName.replace(/\s+/g, '-')}`);
                        const historyList = document.getElementById(`history-list-${teamName.replace(/\s+/g, '-')}`);
                        
                        // Toggle history row
                        if (historyRow.style.display === 'none') {
                            historyRow.style.display = 'table-row';
                            
                            // Load history data from service
                            try {
                                const history = await getTeamHistory(teamName);
                                renderHistory(historyList, history);
                            } catch (error) {
                                historyList.innerHTML = '<div class="error">Failed to load history</div>';
                            }
                        } else {
                            historyRow.style.display = 'none';
                        }
                    });
                });
            }

            function renderHistory(container, history) {
                if (history.length === 0) {
                    container.innerHTML = '<div class="no-history">No recent activity</div>';
                    return;
                }

                const historyHTML = history.map(entry => `
                    <div class="history-entry">
                        <div class="history-entry-header">
                            <span class="history-member">${entry.membro}</span>
                            <span class="history-date">${formatDate(entry.data)}</span>
                        </div>
                        <div class="history-description">${entry.descri√ß√£o}</div>
                        <div class="history-points">
                            <span class="points-type ${entry.tipo.toLowerCase()}">${entry.tipo}</span>
                            <span class="points-value">+${entry.pontos} pts</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = historyHTML;
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            async function updateStats() {
                try {
                    const stats = await getLeaderboardStats();
                    document.getElementById('totalParticipants').textContent = stats.totalParticipants;
                    document.getElementById('activeTeams').textContent = stats.activeTeams;
                    document.getElementById('totalPoints').textContent = stats.totalPoints.toLocaleString();
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            function setupHamburgerMenu() {
                const hamburgerMenu = document.querySelector('.hamburger-menu');
                if (hamburgerMenu) {
                    hamburgerMenu.addEventListener('click', function() {
                        this.classList.toggle('active');
                    });

                    // Close menu when clicking outside
                    document.addEventListener('click', function(event) {
                        if (!hamburgerMenu.contains(event.target)) {
                            hamburgerMenu.classList.remove('active');
                        }
                    });
                }
            }


        </script>
    </body>
</html> 